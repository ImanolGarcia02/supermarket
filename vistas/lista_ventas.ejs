<%- include('header') %>

<div class="text-center mb-4">
  <h2>Ventas</h2>
</div>

<!-- üîç BUSCAR POR FECHA -->
<form action="/ventas/buscar/fecha" method="GET" class="mb-3">
  <label class="form-label fw-bold">Buscar por fecha:</label>
  <input type="date" name="fecha" class="form-control" required>
  <button class="btn btn-primary mt-2" type="submit">Buscar</button>
</form>

<!-- Solo el vendedor puede a√±adir ventas -->
<% if (usuario && usuario.role === "vendedor") { %>
  <div class="mb-3 text-end">
    <a href="/ventas/nuevo" class="btn btn-success">A√±adir Venta</a>
  </div>
<% } %>

<% if (ventas.length === 0) { %>
  <p class="alert alert-info text-center">No hay ventas registradas.</p>
<% } else { %>
  <div class="table-responsive">
    <table class="table table-striped table-hover align-middle">
      <thead class="table-primary text-center">
        <tr>
          <th>Item</th>
          <th>Comprador</th>
          <th>Cu√°ntos</th>
          <th>Fecha</th>
          <th>Total</th>
          <th>Opciones</th>
        </tr>
      </thead>
      <tbody>
        <% ventas.forEach(venta => { %>
        <tr>
          <td><%= venta.productoId ? venta.productoId.nombre : "Producto eliminado" %></td>
          <td><%= venta.cliente %></td>
          <td><%= venta.cantidad %></td>
          <td><%= new Date(venta.fechaVenta).toLocaleDateString() %></td>
          <td>$<%= Number(venta.total).toFixed(2) %></td>

          <td class="text-center">
            <% if (usuario && usuario.role === "vendedor") { %>
              <a href="/ventas/<%= venta._id %>/editar" class="btn btn-sm btn-outline-secondary me-1">
                Modificar
              </a>

              <% if (!venta.cancelada) { %>
                <form action="/ventas/<%= venta._id %>/cancelar?_method=PUT" method="POST" style="display:inline;">
                  <button type="submit" class="btn btn-sm btn-warning" onclick="return confirm('¬øCancelar esta venta?')">
                    Cancelar
                  </button>
                </form>
              <% } else { %>
                <span class="text-muted">Cancelada</span>
              <% } %>

            <% } else { %>
              <span class="text-muted">Solo lectura</span>
            <% } %>
          </td>
        </tr>
        <% }); %>
      </tbody>
    </table>
  </div>
<% } %>
